<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>Generating an intermediate certificate in FreeIPA and using it for k3s | tw0flower</title>
	<meta name="description" content="It is no secret that self-signed certificates should be avoided as they do not allow properly authenticating systems. k3s makes it very easy to just fire up with self-signed certificates, and it's really easy to just leave it as-is. However, if your host is already registered to a FreeIPA server …">
	<meta name="author" content="">
	<link rel="author" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="tw0flower_">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="tw0flower_">
	<meta property="og:title" content="Generating an intermediate certificate in FreeIPA and using it for k3s">
	<meta property="og:description" content="It is no secret that self-signed certificates should be avoided as they do not allow properly authenticating systems. k3s makes it very easy to just fire up with self-signed certificates, and it's really easy to just leave it as-is. However, if your host is already registered to a FreeIPA server …">
	<meta property="og:image" content="../images/icons/avatar.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="../drafts/generating-an-intermediate-certificate-in-freeipa-and-using-it-for-k3s.html">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css?e03582c2" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
	<link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32">
	<meta name="theme-color" content="">

	<meta name="msapplication-TileColor" content="">
	<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="/images/icons/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/images/icons/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/images/icons/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/images/icons/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<aside>
			<a href="/"><img id="avatar" alt="Site Avatar" src="/images/icons/avatar.png"></a>
			<div id="name"><a href="/">tw0flower</a></div>
			<div id="bio">Devops Engineer, Python developer and general computer handyman</div>

			<div id="sidebar-links">
				<a href="/pages/about/">About</a>&nbsp;|&nbsp;<a href="/archive/">Archive</a>
			</div>

			<div id="social">
				<a href="https://github.com/tw0flower" title="GitHub" class="icon fa fa-github"></a>
				<a href="https://twitter.com/tw0flower_" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="https://tech.lgbt/@tw0flower" title="Mastodon" class="icon fa fa-comments-o"></a>
				<a href="/atom.xml" title="Atom Feed" class="icon fa fa-solid fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
		</aside>

		<article>
	<h1 class="title"><a href="/drafts/generating-an-intermediate-certificate-in-freeipa-and-using-it-for-k3s.html" title="Permalink to Generating an intermediate certificate in FreeIPA and using it for k3s">Generating an intermediate certificate in FreeIPA and using it for k3s</a></h1>
	<time class="date" datetime="2023-06-24 15:58:00+09:00">sam. 24 juin 2023</time>
	<div class="content">
		<p>It is no secret that self-signed certificates should be avoided as they do not allow properly authenticating systems. k3s makes it very easy to just fire up with self-signed certificates, and it's really easy to just leave it as-is.</p>
<p>However, if your host is already registered to a FreeIPA server (this is the case if you have run <code>ipa-client-install</code>), the process of getting an intermediate certificate for your host that can be used by k3s is very easy. Better even, this intermediate CA will now be automatically renewed before it expires.</p>
<p>This guide assumes that you have already started the server and that the certificates have been generated. You <em>can</em> actually provision the certificates before starting the server <em>but</em> it means you would have to clean the in-use data directory which is not recommended and therefore really inconvenient. Therefore, I'd rather just start k3s and deal with rotating the keys, which is what this guide describes.</p>
<p>First, let's get the intermediate CA from FreeIPA.</p>
<div class="codehilite"><pre><span></span><code>ipa-getcert<span class="w"> </span>request<span class="w"> </span>-k<span class="w"> </span>/etc/ssl/certs/<span class="nv">$HOSTNAME</span>.key<span class="w"> </span>-f<span class="w"> </span>/etc/ssl/certs/<span class="nv">$HOSTNAME</span>.pem
</code></pre></div>

<p>If the command succeeded you should see the two new files in the <code>/etc/ssl/certs</code> directory.</p>
<p>Now all we have to do is link this intermediate certificate to the right location for k3s to use, as per <a href="https://docs.k3s.io/cli/certificate#using-custom-ca-certificates">the documentation</a>. We use 3 files: the two files that make the intermediate CA we just got from FreeIPA and the root CA that was installed when you run <code>ipa-client-install</code>. This file is located in <code>/etc/ssl/certs/IPA_REALM.pem</code> where <code>IPA_REALM</code> is the name of the FreeIPA realm your server is registered in.</p>
<div class="codehilite"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/k3s/server/tls
ln<span class="w"> </span>-s<span class="w"> </span>/etc/ssl/certs/IPA_REALM.pem<span class="w"> </span>/var/lib/rancher/k3s/server/tls/root-ca.pem
ln<span class="w"> </span>-s<span class="w"> </span>/etc/ssl/certs/<span class="nv">$HOSTNAME</span>.pem<span class="w"> </span>/opt/k3s/server/tls/intermediate-ca.pem
ln<span class="w"> </span>-s<span class="w"> </span>/etc/ssl/certs/<span class="nv">$HOSTNAME</span>.key<span class="w"> </span>/opt/k3s/server/tls/intermediate-ca.key
</code></pre></div>

<p>We also </p>
<p>Boom, now, let's generate this cert</p>
	</div>


			<hr>
		</article>

		<footer>
			<p>Built with <a href="https://github.com/getpelican/pelican">Pelican</a> using the <a href="https://github.com/iKevinY/pneumatic">Pneumatic</a> theme.</p>
		</footer>
	</div>


</body>
</html>